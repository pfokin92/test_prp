# Тестовое задание

## Текст задания:
Необходимо автоматизировать сбор данных рейтингов компании.

Нужно сделать парсер страницы компании/сайта в trustpilot, собирать оттуда данные оценок и далее их обрабатывать.
Для примера возьмем страницу Google: [Trustpilot](https://www.trustpilot.com/review/www.google.com)

Какие данные собираем:
- Общий рейтинг
- Кол-во оценок
- Кол-во оценок по звездам: от 1 до 5.

Требования к отчету:
- Данные должны собираться каждый час и складываться в таблицу Google Sheets.
- Так же нужно создать сводную таблицу, которая будет показывать динамику изменения всех собранных показателей:
- Изменение относительно предыдущего показателя, подсвечивать красным, если уменьшился, зеленым если увеличился.
- Изменение за последнюю неделю в процентах, подсвечивать красным, если уменьшился, зеленым если увеличился.
- Нарисовать график изменения Total score и Total reviews count за последние 30 дней.
- Написать App Script для экспорта отчета в формате PDF. Шаблон отчета должен быть в виде отдельного Google документа. Оформление отчета можно сделать максимально простым.

Исторические данные для демонстрации работы можно сгенерировать на 30 дней.

## Описание

Файл с решением задания [Google Sheets](https://docs.google.com/spreadsheets/d/1B77mYbYfKsF0elGtb3DrYB6uFOrqBWfwI7JVy9a8WmQ/edit#gid=1658455141)

Папка с результатами генерации отчета и шаблоном отчета [Отчет](https://drive.google.com/drive/folders/1WTDzUkzfJuFpNd6x0oqe1MNsfsmUEGBY?usp=drive_link)

### Листы в [Google Sheets](https://docs.google.com/spreadsheets/d/1B77mYbYfKsF0elGtb3DrYB6uFOrqBWfwI7JVy9a8WmQ/edit#gid=1658455141)

***Test home*** - лист с текстом задания

***`www.google.com`*** - лист с данными, которые получили в результате парсинга данных. Название листа это название компании, по которой выполнялсы сбор данных

- ***id*** - номер записи в базе даннх
- ***datetime*** - время получения данных с сайта
- ***to_report*** - содержит информацию есть ли изменения количества оценок относительно предыдущей записили
- ***overall_rating*** - общий рейтинг 
- ***num_of_rating*** - количество оценок
- ***num_of_one*** - количество оценок с одной звездой
- ***num_of_two*** - количество оценок с двумя звездами
- ***num_of_three*** - количество оценок с тремя звездами
- ***num_of_four*** - количество оценок с четырьмя звездами
- ***num_of_five*** - количество оценок с пятью звездами
- ***day*** - день получения данных
- ***month*** - месяц получения данных
- ***year*** - год получения данных
- ***week*** - день недели получения данных

***db for demo*** - данные которые были сгенирированы для демонстрации и подготовки отчетов

***pivot*** - сводная таблица, которая показывает динамику за последние 31 дней. Так же отмечается 

***weeks*** - сводная таблица, которая показывает динамику за неделю, как изменились показатели за неделю

#### Макросы

**Get new review data** - запускает парсер для получения данных

**Create new report** - создает отчет PDF на основе недельной динамики 

**Highlight Change in pivot table** - выделяет измения относительно предыдущего дня

### Функции Google Apps Script

**onOpen()** - запускается при открытии файла [Google Sheets]. Отображение меню с макросами. 

**variables** - в файне хранятся постоянные переменные которые используются в других функциях

**runCode()** - запускает парсер, которые получает данные с сайта [Trustpilot](https://www.trustpilot.com/) и записывает полученные полученные данные на лист "www.google.com". Эту функцию можно сделать универсальной для разных компаний. Функция добавлена в триггер, который запускается каждый час

**highlightChange()** - функция, которая должна запускаеться на листе *"pivot"*. Если лист другой будет выведено предупреждение и код не выполнется

**createReport()** - функция создает отчет в ***PDF*** формате. Данные берутся с листа *weeks* и заносятся в шаблон. Функция возращает ссылку на папку с отчетом.

#### Функции парсера

**getBlock(html, tag, idxStart)** - функция для поиска дочернего элемента. Возращает текстовую переменную с дочерними элементами

-**html** - передача *html* разметки в текстовом формате
-**tag** - тег, который необходимо найти 
-**idxStart** - позиция с которой начинается поиск, необходимо использовать в комбинации с `indexOf()`. В `indexOf()` передаем `class`, нужного нам тега.


**getAttrName(html, attr, i)** - функция для поиска дочернего элемента. Возращает текстовую переменную с содержимым атрибута 

-**html** - передача *html* разметки в текстовом формате
-**attr** - название атрибута, который необходимо найти 
-**i** - позиция с которой начинается поиск, необходимо использовать в комбинации с `indexOf()`. В `indexOf()` передаем `class`, нужного нам тега.

**getReviews(company)** - парсинг данных, возращает объект c результатами парсинга данных

```
  {
    score: score, 
    count: count,
    numStars:
    {
      five: five,
      four: four,
      three: three,
      two: two,
      one: one
    }
  };  
}
```

-**company** - компания по которой собираются данные
- ***score*** - общий рейтинг
- ***count*** - количество оценок
- ***five*** - количество оценок с 5-ю звездами
- ***four*** - количество оценок с 4-мя звездами
- ***three*** - количество оценок с 3мя звездами
- ***two*** - количество оценок с 2-мя звездами
- ***one*** - количество оценок с 1-ой звездой

**insertRow(data)** - функция добавления данных на лист ***`www.google.com`***. Если листа нет с названием компании. Он создается

-**data** - данные для добавления на лист

